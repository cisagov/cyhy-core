#!/usr/bin/env python
"""Cyber-Hygiene GeoIP maintenance tool.

Usage:
  cyhy-geoip [--section SECTION]
  cyhy-geoip (-h | --help)

Options:
  -h --help                      Show this screen.
  -s SECTION --section=SECTION   Configuration section to use.
"""

from docopt import docopt
import geoip2.database
import pymongo

from cyhy.db import database
from cyhy.core.geoloc import GeoLocDB

def main():
    args = docopt(__doc__, version='v0.0.1')

    cyhy_db = database.db_from_config(args['--section'])
    geoip_db = GeoLocDB()

    for host in cyhy_db.HostDoc.find():
        new_loc = geoip_db.lookup(host.ip
        if new_loc != host["loc"]:
            host["loc"] = new_loc
            host.save()

if __name__=='__main__':
    main()
