#!/usr/bin/env python
"""Cyber Hygiene GeoIP maintenance tool.

Usage:
  cyhy-geoip [--section SECTION]
  cyhy-geoip (-h | --help)

Options:
  -h --help                      Show this screen.
  -s SECTION --section=SECTION   Configuration section to use.
"""

import logging

from docopt import docopt
import geoip2.database
import pymongo

from cyhy.core.geoloc import GeoLocDB
from cyhy.db import database
from cyhy.util import util

UPDATE_INCREMENT = 100000

logger = logging.getLogger("cyhy-geoip")
LOG_FILE = "/var/log/cyhy/geoip.log"
util.setup_logging(logging.INFO, filename=LOG_FILE)


def main():
    args = docopt(__doc__, version="v0.0.1")

    cyhy_db = database.db_from_config(args["--section"])
    geoip_db = GeoLocDB()

    hosts = cyhy_db.HostDoc.find()
    total_documents = hosts.count()

    logger.info("Beginning update of GeoIP data in hosts collection [{} document(s)]".format(total_documents))

    total_processed = 0
    total_updated = 0
    for host in hosts:
        # lookup() returns a tuple but the host object stores it as a list
        new_loc = list(geoip_db.lookup(host.ip))
        if new_loc != host["loc"]:
            old_loc = host["loc"]
            host["loc"] = new_loc
            host.save()
            total_updated += 1
            logger.info(
                "Host %s location changed from [%s, %s] to [%s, %s]",
                host["ip"],
                str(old_loc[0]),
                str(old_loc[1]),
                str(new_loc[0]),
                str(new_loc[1]),
            )

        total_processed += 1
        if (total_processed % UPDATE_INCREMENT) == 0:
            logger.info("Processed {}/{} host documents".format(total_processed, total_documents))

    logger.info("Finished update with %d record(s) changed", total_updated)


if __name__ == "__main__":
    main()
