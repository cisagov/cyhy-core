#!/usr/bin/env python
"""Export scan request documents.

Usage:
  cyhy-export [--section SECTION] [--file-path PATH] [OWNER ...]
  cyhy-export (-h | --help)
  cyhy-export --version

Options:
  -h --help                      Show this screen.
  --version                      Show version.

  -f PATH --file-path PATH       Output to a path [default: .].
  -s SECTION --section=SECTION   Configuration section to use.

Notes:
  If no owners are specified, all request documents will be output.

"""

from __future__ import print_function

import os

from docopt import docopt
import progressbar as pb

from cyhy.db import database
from cyhy.util import util

PB_INIT_WIDGETS = [
    "Exporting: ",
    pb.SimpleProgress(),
    " ",
    # MIGRATION : unichr becomes chr in Py3
    pb.Bar(marker=unichr(0x25B6)),
    " ",
    pb.ETA(),
]


def get_all_owners(mongo_db):
    """Return all owners in the database."""
    return mongo_db.RequestDoc.get_all_owners()


def export_requests(mongo_db, owners, path):
    """Export requests from a given owner to a file."""
    for owner in owners:
        request = mongo_db.RequestDoc.get_by_owner(owner)
        if not request:
            print("Could not find request document for ", owner)
            continue
        filename = os.path.join(path, owner + ".json")
        with open(filename, "wb") as f:
            f.write(util.to_json(request))


def main():
    """Export request documents for a given (or all) owner(s) to a file."""
    args = docopt(__doc__, version="v0.0.1")

    mongo_db = database.db_from_config(args["--section"])

    if not args["OWNER"]:
        args["OWNER"] = get_all_owners(mongo_db)

    export_requests(mongo_db, args["OWNER"], args["--file-path"])


if __name__ == "__main__":
    main()
